{% extends "base.html" %}
{% block title %}カレンダー{% endblock %}
 
{% block content %}
<section class="calendar-section">
  <!-- タイトル -->
  <h1 class="calendar-title">カレンダー</h1>
 
  <!-- 上下構成 -->
  <div class="calendar-top">
    <!-- 左下：月・週ボタン -->
    <div class="view-switch">
      <button class="view-btn active" data-view="month">月</button>
      <button class="view-btn" data-view="week">週</button>
    </div>
 
    <!-- 右下：月移動ボタン -->
    <div class="month-switch">
      <button class="arrow-btn">←</button>
      <span class="year-label"></span>
      <span class="month-label"></span>
      <button class="arrow-btn">→</button>
    </div>
  </div>
 
  <!-- カレンダー本体 -->
  <div class="calendar-container">
    <!-- JSでカレンダー描画 -->
  </div>
 
  <!-- 確定ボタン -->
  <div class="confirm-btn-container" style="margin-top:20px; text-align:center;">
    <button class="confirm-btn">確定</button>
  </div>
</section>
 
<style>
  /* ===========================
   日付ボタンデザイン
=========================== */
  .date-btn {
    width: 90px;
    height: 90px;
    font-size: 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    background-color: #ffecb3;
    transition: 0.2s;
  }
 
  .date-btn:hover:not(:disabled) {
    background-color: #ffe066;
  }
 
  /* 今日の日付ボタン */
  .date-btn.today {
    background-color: #eccb46ff !important;
    border: 2px solid rgba(1, 1, 1, 1);
  }
 
  /* クリックで選択されたボタン */
  .date-btn.selected {
    background-color: #bbb !important;
  }
 
  /* 年の表示（月と合わせる） */
  .year-label {
    font-size: 16px;
    font-weight: bold;
  }
</style>
 
 
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const buttons = document.querySelectorAll(".view-btn");
    const monthLabel = document.querySelector(".month-label");
    const yearLabel = document.querySelector(".year-label");
    const calendarContainer = document.querySelector(".calendar-container");
    const confirmBtn = document.querySelector(".confirm-btn");
    const today = new Date();
    let currentView = "month";
    let currentDate = new Date(today);
    let selectedDate = null;
 
    // カレンダー描画
    function renderCalendar() {
      calendarContainer.innerHTML = "";
      if (currentView === "month") renderMonthView();
      else if (currentView === "week") renderWeekView();
    }
 
    // 月表示
    function renderMonthView() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      yearLabel.textContent = `${year}年`;
      monthLabel.textContent = `${month + 1}月`;
 
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay();
 
      const table = document.createElement("table");
      table.className = "calendar-table view-month";
 
      // 曜日ヘッダー
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"].forEach((day, i) => {
        const th = document.createElement("th");
        th.textContent = day;
        if (i === 0) th.classList.add("sun");
        if (i === 6) th.classList.add("sat");
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);
 
      // 日付部分
      const tbody = document.createElement("tbody");
      let row = document.createElement("tr");
 
      // 前空白
      for (let i = 0; i < startDay; i++) {
        const td = document.createElement("td");
        td.classList.add("gray");
        row.appendChild(td);
      }
 
      // 日付生成
      for (let d = 1; d <= lastDay.getDate(); d++) {
        const date = new Date(year, month, d);
        const td = document.createElement("td");
        const btn = document.createElement("button");
        btn.textContent = d;
        btn.classList.add("date-btn");
 
        // 今日なら today クラス追加
        if (isSameDate(date, today)) {
          btn.classList.add("today");
        }
 
        btn.addEventListener("click", () => {
          const allBtns = calendarContainer.querySelectorAll(".date-btn");
 
          // 同じ日付を再クリック → 解除
          if (selectedDate && isSameDate(selectedDate, date)) {
            btn.classList.remove("selected");
            selectedDate = null;
          } else {
            allBtns.forEach(b => b.classList.remove("selected"));
            btn.classList.add("selected");
            selectedDate = date;
          }
        });
 
        td.appendChild(btn);
        if (date.getDay() === 0) td.classList.add("sun");
        if (date.getDay() === 6) td.classList.add("sat");
 
        row.appendChild(td);
        if (date.getDay() === 6) {
          tbody.appendChild(row);
          row = document.createElement("tr");
        }
      }
 
      if (row.children.length > 0) tbody.appendChild(row);
      table.appendChild(tbody);
      calendarContainer.appendChild(table);
    }
 
    // 週表示
    function renderWeekView() {
      const startOfWeek = new Date(currentDate);
      startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);
 
      yearLabel.textContent = `${startOfWeek.getFullYear()}年`;
      monthLabel.textContent = `${startOfWeek.getMonth() + 1}月${startOfWeek.getDate()}日〜${endOfWeek.getMonth() + 1}月${endOfWeek.getDate()}日`;
 
      const table = document.createElement("table");
      table.className = "calendar-table view-week";
 
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"].forEach(day => {
        const th = document.createElement("th");
        th.textContent = day;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);
 
      const tbody = document.createElement("tbody");
      const row = document.createElement("tr");
 
      for (let i = 0; i < 7; i++) {
        const date = new Date(startOfWeek);
        date.setDate(startOfWeek.getDate() + i);
        const td = document.createElement("td");
        const btn = document.createElement("button");
        btn.textContent = date.getDate();
        btn.classList.add("date-btn");
 
        // 今日なら today クラス追加
        if (isSameDate(date, today)) {
          btn.classList.add("today");
        }
 
        btn.addEventListener("click", () => {
          const allBtns = calendarContainer.querySelectorAll(".date-btn");
 
          if (selectedDate && isSameDate(selectedDate, date)) {
            btn.classList.remove("selected");
            selectedDate = null;
          } else {
            allBtns.forEach(b => b.classList.remove("selected"));
            btn.classList.add("selected");
            selectedDate = date;
          }
        });
 
        td.appendChild(btn);
        row.appendChild(td);
      }
 
      tbody.appendChild(row);
      table.appendChild(tbody);
      calendarContainer.appendChild(table);
    }
 
    // 日付比較
    function isSameDate(a, b) {
      return (
        a.getFullYear() === b.getFullYear() &&
        a.getMonth() === b.getMonth() &&
        a.getDate() === b.getDate()
      );
    }
 
    // 表示切替
    buttons.forEach(btn => {
      btn.addEventListener("click", () => {
        buttons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentView = btn.dataset.view;
        renderCalendar();
      });
    });
 
    // ← → ボタン
    const prev = document.querySelectorAll(".arrow-btn")[0];
    const next = document.querySelectorAll(".arrow-btn")[1];
 
    prev.addEventListener("click", () => {
      if (currentView === "month") {
        currentDate.setMonth(currentDate.getMonth() - 1);
      } else if (currentView === "week") {
        currentDate.setDate(currentDate.getDate() - 7);
      }
      renderCalendar();
    });
 
    next.addEventListener("click", () => {
      if (currentView === "month") {
        currentDate.setMonth(currentDate.getMonth() + 1);
      } else if (currentView === "week") {
        currentDate.setDate(currentDate.getDate() + 7);
      }
      renderCalendar();
    });
 
    // 確定ボタン
    confirmBtn.addEventListener("click", () => {
      if (selectedDate) {
        const y = selectedDate.getFullYear();
        const m = String(selectedDate.getMonth() + 1).padStart(2, '0');
        const d = String(selectedDate.getDate()).padStart(2, '0');
 
        const paramDate = `${y}-${m}-${d}`;
 
        window.location.href = `/class_list/?date=${paramDate}`;
      } else {
        alert("日付を選択してください");
      }
    });
 
 
    renderCalendar();
  });
</script>
 
{% endblock %}